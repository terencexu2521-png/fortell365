name: Generate and Deploy SEO Content

on:
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©è‡ªåŠ¨æ‰§è¡Œ
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      count:
        description: 'Number of articles to generate'
        required: false
        default: '30'
        type: string

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Get changed files
      id: changes
      run: |
        echo "changed_files=$(git diff --name-only HEAD~1 HEAD | grep -E '\.(html|json|md)$' | wc -l)" >> $GITHUB_OUTPUT
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Generate SEO content
      run: |
        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p public/seo
        mkdir -p seo_pages
        
        # è·å–è¦ç”Ÿæˆçš„æ–‡ç« æ•°é‡
        COUNT=${INPUT_COUNT:-30}
        if [ -z "$COUNT" ]; then
          COUNT="30"
        fi
        
        echo "ç”Ÿæˆ $COUNT ç¯‡æ–‡ç« ..."
        
        # ç”ŸæˆæŒ‡å®šæ•°é‡çš„æ–‡ç« 
        python generate_seo_content.py
        
        # éªŒè¯ç”Ÿæˆç»“æœ
        if [ ! -d "seo_pages" ]; then
          echo "é”™è¯¯ï¼šæ²¡æœ‰ç”Ÿæˆseo_pagesç›®å½•"
          exit 1
        fi
        
        if [ -z "$(ls -A seo_pages/*.html 2>/dev/null)" ]; then
          echo "é”™è¯¯ï¼šæ²¡æœ‰ç”ŸæˆHTMLæ–‡ä»¶"
          ls -la seo_pages/
          exit 1
        fi
        
        echo "âœ… SEOå†…å®¹ç”ŸæˆæˆåŠŸ"
        echo "ç”Ÿæˆçš„æ–‡ä»¶æ•°é‡: $(ls seo_pages/*.html | wc -l)"
        
    - name: List generated files
      run: |
        echo "=== ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨ ==="
        echo "seo_pages/ ç›®å½•å†…å®¹:"
        ls -la seo_pages/
        echo ""
        echo "HTMLæ–‡ä»¶:"
        ls -la seo_pages/*.html | head -10
        echo "..."
        echo "æ€»å…±ç”Ÿæˆ $(ls seo_pages/*.html | wc -l) ä¸ªHTMLæ–‡ä»¶"
        
    - name: Move files to public/seo
      run: |
        # å°†ç”Ÿæˆçš„æ–‡ä»¶ç§»åŠ¨åˆ°æ­£ç¡®çš„ä½ç½®
        if [ -d "seo_pages" ] && [ -n "$(ls -A seo_pages/*.html 2>/dev/null)" ]; then
          echo "æ­£åœ¨å¤åˆ¶æ–‡ä»¶åˆ° public/seo/"
          cp seo_pages/*.html public/seo/
          echo "âœ… æ–‡ä»¶å¤åˆ¶å®Œæˆ"
          echo "public/seo/ ç›®å½•å†…å®¹:"
          ls -la public/seo/*.html | head -10
          echo "..."
        else
          echo "âŒ æ²¡æœ‰æ‰¾åˆ°å¯å¤åˆ¶çš„æ–‡ä»¶"
          exit 1
        fi
        
    - name: Create deployment summary
      run: |
        # åˆ›å»ºéƒ¨ç½²æ‘˜è¦
        SUMMARY_FILE="deployment_summary.md"
        echo "# Fortell365 SEO Content Deployment" > $SUMMARY_FILE
        echo "" >> $SUMMARY_FILE
        echo "Generated at: $(date)" >> $SUMMARY_FILE
        echo "GitHub Actions Run: ${{ github.run_number }}" >> $SUMMARY_FILE
        echo "Trigger: ${{ github.event_name }}" >> $SUMMARY_FILE
        echo "" >> $SUMMARY_FILE
        
        if [ -d "public/seo" ] && [ -n "$(ls -A public/seo/*.html 2>/dev/null)" ]; then
          echo "## Generated Files" >> $SUMMARY_FILE
          echo "Total files: $(ls public/seo/*.html | wc -l)" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          echo "Latest generated files:" >> $SUMMARY_FILE
          ls -lt public/seo/*.html | head -10 | while read line; do
            filename=$(basename "$line")
            echo "- $filename" >> $SUMMARY_FILE
          done
        fi
        
        echo "" >> $SUMMARY_FILE
        echo "## Deployment Info" >> $SUMMARY_FILE
        echo "- Repository: ${{ github.repository }}" >> $SUMMARY_FILE
        echo "- Branch: ${{ github.ref_name }}" >> $SUMMARY_FILE
        echo "- Commit: ${{ github.sha }}" >> $SUMMARY_FILE
        
        cat $SUMMARY_FILE
        
    - name: Add and commit changes
      run: |
        # é…ç½®git
        git config --global user.name "Fortell365 Bot"
        git config --global user.email "bot@fortell365.com"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        git add public/seo/
        git add seo_pages/
        git add deployment_summary.md
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
        if git diff --cached --quiet; then
          echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          exit 0
        fi
        
        # ç”Ÿæˆæäº¤ä¿¡æ¯
        FILE_COUNT=$(ls seo_pages/*.html 2>/dev/null | wc -l)
        COMMIT_MSG="ğŸ¤– Auto-generated SEO content - $FILE_COUNT articles

- Generated on: $(date '+%Y-%m-%d %H:%M:%S')
- Trigger: ${{ github.event_name }}
- Articles count: $FILE_COUNT

Files added:
$(git diff --cached --name-only)"
        
        # æäº¤å˜æ›´
        git commit -m "$COMMIT_MSG"
        
        # æ¨é€åˆ°GitHub
        git push origin main
        
        echo "âœ… å˜æ›´å·²æ¨é€åˆ°GitHub"
        
    - name: Trigger Vercel deployment
      run: |
        echo "ğŸš€ å‡†å¤‡è§¦å‘Verceléƒ¨ç½²..."
        
        # è·å–æœ€æ–°çš„commit SHA
        LATEST_SHA=$(git rev-parse HEAD)
        echo "æœ€æ–°æäº¤SHA: $LATEST_SHA"
        
        echo "âœ… SEOå†…å®¹å·²æˆåŠŸéƒ¨ç½²åˆ°GitHub"
        echo "ğŸ“Š ç”Ÿæˆç»Ÿè®¡:"
        echo "   - æ–°å¢æ–‡ä»¶: $(ls seo_pages/*.html 2>/dev/null | wc -l) ä¸ªHTMLæ–‡ä»¶"
        echo "   - æäº¤SHA: $LATEST_SHA"
        echo "   - ä»“åº“: ${{ github.repository }}"
        echo ""
        echo "ğŸ”„ Vercelå°†è‡ªåŠ¨æ£€æµ‹åˆ°å˜æ›´å¹¶å¼€å§‹éƒ¨ç½²..."
        echo "ğŸ’¡ æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹é“¾æ¥æŸ¥çœ‹éƒ¨ç½²è¿›åº¦ï¼š"
        echo "   https://vercel.com/${{ github.repository_owner }}/${{ github.event.repository.name }}/deployments"
        
    - name: Upload deployment artifacts
      uses: actions/upload-artifact@v4  # âœ… å·²å‡çº§åˆ°v4ç‰ˆæœ¬
      if: always()
      with:
        name: seo-deployment-summary
        path: |
          seo_pages/
          deployment_summary.md
        retention-days: 7

  notify-deployment:
    needs: generate-and-deploy
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4  # âœ… å·²å‡çº§åˆ°v4ç‰ˆæœ¬
      with:
        name: seo-deployment-summary
        path: ./
        
    - name: Create notification
      run: |
        if [ "${{ needs.generate-and-deploy.result }}" = "success" ]; then
          echo "ğŸ‰ SEOå†…å®¹éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          echo ""
          echo "ğŸ“Š éƒ¨ç½²æ‘˜è¦ï¼š"
          if [ -f "deployment_summary.md" ]; then
            cat deployment_summary.md
          else
            echo "éƒ¨ç½²æ‘˜è¦æ–‡ä»¶ä¸å­˜åœ¨"
          fi
        else
          echo "âŒ SEOå†…å®¹éƒ¨ç½²å¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥æ—¥å¿—è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚"
          exit 1
        fi
