name: SEO Automation

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      count:
        description: 'Number of articles to generate'
        required: false
        default: '30'
        type: string

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Debug directory structure
      run: |
        echo "=== å½“å‰ç›®å½•ç»“æž„ ==="
        pwd
        ls -la
        echo ""
        echo "=== æ£€æŸ¥Pythonè„šæœ¬ ==="
        find . -name "generate_seo_content.py" -type f
        echo ""
        echo "=== å½“å‰ç›®å½•æ–‡ä»¶ ==="
        ls -la *.py
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml python-dateutil jinja2
        
    - name: Generate SEO content
      run: |
        echo "=== æ£€æŸ¥ç›®å½•ç»“æž„ ==="
        ls -la
        echo ""
        
        # æŸ¥æ‰¾Pythonè„šæœ¬
        SCRIPT_PATH=$(find . -name "generate_seo_content.py" -type f | head -1)
        echo "æ‰¾åˆ°è„šæœ¬è·¯å¾„: $SCRIPT_PATH"
        
        if [ -z "$SCRIPT_PATH" ]; then
          echo "âŒ æ²¡æœ‰æ‰¾åˆ° generate_seo_content.py æ–‡ä»¶"
          exit 1
        fi
        
        echo "=== è¿è¡Œè„šæœ¬ ==="
        python "$SCRIPT_PATH"
        
        # éªŒè¯ç”Ÿæˆç»“æžœ
        if [ ! -d "seo_pages" ]; then
          echo "âŒ æ²¡æœ‰ç”Ÿæˆseo_pagesç›®å½•"
          exit 1
        fi
        
        FILE_COUNT=$(ls seo_pages/*.html 2>/dev/null | wc -l)
        if [ $FILE_COUNT -eq 0 ]; then
          echo "âŒ æ²¡æœ‰ç”ŸæˆHTMLæ–‡ä»¶"
          exit 1
        fi
        
        echo "âœ… ç”Ÿæˆ $FILE_COUNT ä¸ªæ–‡ä»¶"
        
    - name: Copy files to public
      run: |
        mkdir -p public/seo
        cp seo_pages/*.html public/seo/
        echo "âœ… æ–‡ä»¶å¤åˆ¶å®Œæˆ"
        
    - name: Commit and push changes
      run: |
        git config --global user.name "Fortell365 Bot"
        git config --global user.email "bot@fortell365.com"
        
        git add public/seo/
        
        if git diff --cached --quiet; then
          echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          exit 0
        fi
        
        FILE_COUNT=$(ls seo_pages/*.html 2>/dev/null | wc -l)
        git commit -m "ðŸ¤– Auto SEO content - $FILE_COUNT articles"
        git push origin main
        echo "âœ… æŽ¨é€åˆ°GitHubæˆåŠŸ"
        
    - name: Show success
      run: |
        echo "ðŸŽ‰ SEOè‡ªåŠ¨åŒ–éƒ¨ç½²æˆåŠŸï¼"
        echo "ðŸ“Š ç”Ÿæˆç»Ÿè®¡ï¼š"
        echo "   - æ–‡ç« æ•°é‡: $(ls seo_pages/*.html 2>/dev/null | wc -l)"
        echo "   - æ—¶é—´: $(date)"
        echo "   - ä»“åº“: ${{ github.repository }}"
